<!DOCTYPE html>
<html>
<head>
    <title>Neon Defender: Ultimate</title>
    <style>
        body { background: #050505; color: #fff; font-family: 'Segoe UI', sans-serif; margin: 0; overflow: hidden; display: flex; justify-content: center; align-items: center; height: 100vh; }
        canvas { border: 2px solid #1f2833; background: #000; }
        #ui { position: absolute; top: 20px; left: 20px; font-size: 24px; pointer-events: none; z-index: 10; display: none; line-height: 1.6; }
        .overlay { position: absolute; text-align: center; z-index: 20; background: rgba(5, 5, 5, 0.95); padding: 50px; border: 2px solid #66fcf1; box-shadow: 0 0 30px #66fcf1; width: 400px; }
        button { background: transparent; border: 2px solid #66fcf1; color: #66fcf1; padding: 15px 30px; font-size: 20px; cursor: pointer; transition: 0.3s; margin-top: 20px; }
        button:hover { background: #66fcf1; color: #000; }
        h1 { font-size: 50px; color: #66fcf1; text-shadow: 0 0 15px #66fcf1; margin: 0; }
        #boss-ui { position: absolute; top: 120px; width: 500px; height: 15px; background: #222; border: 2px solid #ff3b30; display: none; }
        #boss-hp { width: 100%; height: 100%; background: #ff3b30; transition: width 0.2s; }
    </style>
</head>
<body>

    <div id="mainMenu" class="overlay">
        <h1>NEON DEFENDER</h1>
        <p>WASD/Arrows: Move<br>Space: Auto-Fire<br>E: Use Nuke</p>
        <button onclick="startGame()">START MISSION</button>
    </div>

    <div id="gameOver" class="overlay" style="display:none;">
        <h1>DEFEATED</h1>
        <p id="finalScore" style="font-size: 24px;">Score: 0</p>
        <button onclick="location.reload()">REDEPLOY</button>
    </div>

    <div id="ui">
        SCORE: <span id="score">0</span><br>
        BEST: <span id="high-score" style="color: #f1c40f">0</span><br>
        HP: <span id="hp" style="color:#2ecc71">100</span>% | NUKES: <span id="nuke-count" style="color:#9b59b6">0</span>
    </div>

    <div id="boss-ui"><div id="boss-hp"></div></div>
    
    <canvas id="gameCanvas"></canvas>

    <script>
        const canvas = document.getElementById("gameCanvas");
        const ctx = canvas.getContext("2d");
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;

        let gameState = "MENU";
        let highScore = localStorage.getItem('neonHiScore') || 0;
        document.getElementById('high-score').textContent = highScore;

        let player = { x: canvas.width/2, y: canvas.height/2, size: 18, color: '#66fcf1', facingAngle: 0 };
        let score = 0, health = 100, level = 1, nukes = 0, shake = 0;
        let bullets = [], enemies = [], items = [], keys = {}, boss = null;

        window.addEventListener('keydown', e => {
            keys[e.code] = true;
            if (e.code === "KeyE" && nukes > 0 && gameState === "PLAYING") useNuke();
        });
        window.addEventListener('keyup', e => keys[e.code] = false);

        function startGame() {
            gameState = "PLAYING";
            document.getElementById('mainMenu').style.display = 'none';
            document.getElementById('ui').style.display = 'block';
            spawnEnemyLoop();
        }

        function useNuke() {
            nukes--; shake = 60;
            enemies = [];
            if(boss) boss.hp -= 30;
            document.getElementById('nuke-count').textContent = nukes;
        }

        function update() {
            if (gameState !== "PLAYING") return;

            // Boss Spawn every 5000
            if (score > 0 && score % 5000 === 0 && !boss) {
                boss = { x: canvas.width/2, y: -100, size: 80, hp: 100, maxHp: 100, speed: 2 };
                document.getElementById('boss-ui').style.display = 'block';
            }

            // Movement (8-Way)
            let dx = 0, dy = 0;
            if (keys['KeyW'] || keys['ArrowUp']) dy -= 1;
            if (keys['KeyS'] || keys['ArrowDown']) dy += 1;
            if (keys['KeyA'] || keys['ArrowLeft']) dx -= 1;
            if (keys['KeyD'] || keys['ArrowRight']) dx += 1;
            if (dx !== 0 || dy !== 0) {
                player.x += dx * 6; player.y += dy * 6;
                player.facingAngle = Math.atan2(dy, dx);
            }

            if (keys['Space'] && Date.now() % 120 < 20) {
                bullets.push({ x: player.x, y: player.y, vx: Math.cos(player.facingAngle) * 15, vy: Math.sin(player.facingAngle) * 15 });
            }

            // Boss AI
            if (boss) {
                const bAngle = Math.atan2(player.y - boss.y, player.x - boss.x);
                boss.x += Math.cos(bAngle) * boss.speed;
                boss.y += Math.sin(bAngle) * boss.speed;
                document.getElementById('boss-hp').style.width = (boss.hp / boss.maxHp * 100) + "%";
                if (boss.hp <= 0) {
                    boss = null; score += 1000; health = 100; nukes += 2;
                    document.getElementById('boss-ui').style.display = 'none';
                }
            }

            // Enemy & Bullet Collision
            enemies.forEach((en, i) => {
                const angle = Math.atan2(player.y - en.y, player.x - en.x);
                en.x += Math.cos(angle) * (2.5 + (score/10000));
                en.y += Math.sin(angle) * (2.5 + (score/10000));

                if (Math.hypot(player.x - en.x, player.y - en.y) < player.size + en.size) {
                    health -= 15; shake = 20; enemies.splice(i, 1);
                }

                bullets.forEach((b, bi) => {
                    if (Math.hypot(en.x - b.x, en.y - b.y) < en.size) {
                        if (Math.random() < 0.15) items.push({ x: en.x, y: en.y, type: Math.random() < 0.7 ? 'health' : 'nuke' });
                        score += 10; enemies.splice(i, 1); bullets.splice(bi, 1);
                    }
                });
            });

            bullets.forEach((b, bi) => {
                b.x += b.vx; b.y += b.vy;
                if (boss && Math.hypot(b.x - boss.x, b.y - boss.y) < boss.size) {
                    boss.hp -= 2; bullets.splice(bi, 1); shake = 4;
                }
                if (b.x < 0 || b.x > canvas.width || b.y < 0 || b.y > canvas.height) bullets.splice(bi, 1);
            });

            items.forEach((it, i) => {
                if (Math.hypot(player.x - it.x, player.y - it.y) < player.size + 15) {
                    if (it.type === 'health') health = Math.min(100, health + 20);
                    else nukes++;
                    items.splice(i, 1);
                }
            });

            document.getElementById('score').textContent = score;
            document.getElementById('hp').textContent = Math.max(0, Math.floor(health));
            document.getElementById('nuke-count').textContent = nukes;

            if (health <= 0) {
                if (score > highScore) localStorage.setItem('neonHiScore', score);
                gameState = "GAMEOVER";
                document.getElementById('ui').style.display = 'none';
                document.getElementById('gameOver').style.display = 'block';
                document.getElementById('finalScore').textContent = "Final Score: " + score;
            }
            if (shake > 0) shake *= 0.9;
        }

        function draw() {
            ctx.save();
            if (shake > 0) ctx.translate(Math.random()*shake - shake/2, Math.random()*shake - shake/2);
            ctx.fillStyle = "rgba(0, 0, 0, 0.3)"; ctx.fillRect(0, 0, canvas.width, canvas.height);

            if (gameState === "PLAYING") {
                items.forEach(it => {
                    ctx.fillStyle = it.type === 'health' ? '#2ecc71' : '#9b59b6';
                    ctx.fillRect(it.x - 10, it.y - 10, 20, 20);
                });
                if (boss) {
                    ctx.fillStyle = "#ff3b30"; ctx.shadowBlur = 40; ctx.shadowColor = "#ff3b30";
                    ctx.beginPath(); ctx.arc(boss.x, boss.y, boss.size, 0, Math.PI*2); ctx.fill();
                }
                ctx.fillStyle = player.color; ctx.shadowBlur = 20; ctx.shadowColor = player.color;
                ctx.beginPath(); ctx.arc(player.x, player.y, player.size, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle = "#fff"; bullets.forEach(b => { ctx.beginPath(); ctx.arc(b.x, b.y, 4, 0, Math.PI*2); ctx.fill(); });
                ctx.fillStyle = "#ff3b30"; ctx.shadowBlur = 10; enemies.forEach(en => { ctx.beginPath(); ctx.arc(en.x, en.y, en.size, 0, Math.PI*2); ctx.fill(); });
            }
            ctx.restore();
        }

        function spawnEnemyLoop() {
            if (gameState === "PLAYING" && !boss) {
                const side = Math.floor(Math.random() * 4);
                let x, y;
                if(side === 0) { x = Math.random() * canvas.width; y = -30; }
                else if(side === 1) { x = canvas.width + 30; y = Math.random() * canvas.height; }
                else if(side === 2) { x = Math.random() * canvas.width; y = canvas.height + 30; }
                else { x = -30; y = Math.random() * canvas.height; }
                enemies.push({ x, y, size: 15 });
            }
            setTimeout(spawnEnemyLoop, 800);
        }

        function loop() { update(); draw(); requestAnimationFrame(loop); }
        loop();
    </script>
</body>
</html>